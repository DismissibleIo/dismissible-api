# Render Blueprint for Dismissible API
# https://render.com/docs/infrastructure-as-code
#
# To deploy:
# 1. Copy this file to the root of your repo as render.yaml
# 2. Connect the repo to Render via Dashboard > New > Blueprint
# 3. Render will automatically deploy on pushes to your linked branch

services:
  - type: web
    name: dismissible-api
    runtime: image
    plan: starter
    region: oregon
    healthCheckPath: /health
    image:
      url: docker.io/dismissibleio/dismissible-api:latest # Official prebuilt image - easiest way to get started
    envVars:
      # Core Settings
      - key: DISMISSIBLE_PORT
        value: '10000'

      # Swagger Documentation
      - key: DISMISSIBLE_SWAGGER_ENABLED
        value: 'false'
      - key: DISMISSIBLE_SWAGGER_PATH
        value: 'docs'

      # Storage Configuration
      - key: DISMISSIBLE_STORAGE_TYPE
        value: 'postgres'

      # Database Migrations - run migrations automatically on startup
      - key: DISMISSIBLE_RUN_STORAGE_SETUP
        value: 'true'

      # Postgres Storage
      - key: DISMISSIBLE_STORAGE_POSTGRES_CONNECTION_STRING
        fromDatabase:
          name: dismissible-db
          property: connectionString

      # DynamoDB Storage
      - key: DISMISSIBLE_STORAGE_DYNAMODB_TABLE_NAME
        value: 'dismissible-items'
      - key: DISMISSIBLE_STORAGE_DYNAMODB_AWS_REGION
        value: 'us-east-1'
      - key: DISMISSIBLE_STORAGE_DYNAMODB_ENDPOINT
        value: ''
      - key: DISMISSIBLE_STORAGE_DYNAMODB_AWS_ACCESS_KEY_ID
        value: ''
      - key: DISMISSIBLE_STORAGE_DYNAMODB_AWS_SECRET_ACCESS_KEY
        value: ''
      - key: DISMISSIBLE_STORAGE_DYNAMODB_AWS_SESSION_TOKEN
        value: ''

      # Security (Helmet)
      - key: DISMISSIBLE_HELMET_ENABLED
        value: 'true'
      - key: DISMISSIBLE_HELMET_CSP
        value: 'true'
      - key: DISMISSIBLE_HELMET_COEP
        value: 'true'
      - key: DISMISSIBLE_HELMET_HSTS_MAX_AGE
        value: '31536000'
      - key: DISMISSIBLE_HELMET_HSTS_INCLUDE_SUBDOMAINS
        value: 'true'
      - key: DISMISSIBLE_HELMET_HSTS_PRELOAD
        value: 'false'

      # CORS Configuration
      # Update DISMISSIBLE_CORS_ORIGINS with your frontend domain(s)
      - key: DISMISSIBLE_CORS_ENABLED
        value: 'true'
      - key: DISMISSIBLE_CORS_ORIGINS
        sync: false
      - key: DISMISSIBLE_CORS_METHODS
        value: 'GET,POST,DELETE,OPTIONS'
      - key: DISMISSIBLE_CORS_ALLOWED_HEADERS
        value: 'Content-Type,Authorization,x-request-id'
      - key: DISMISSIBLE_CORS_CREDENTIALS
        value: 'true'
      - key: DISMISSIBLE_CORS_MAX_AGE
        value: '86400'

      # Validation Settings
      - key: DISMISSIBLE_VALIDATION_DISABLE_ERROR_MESSAGES
        value: 'true'
      - key: DISMISSIBLE_VALIDATION_WHITELIST
        value: 'true'
      - key: DISMISSIBLE_VALIDATION_FORBID_NON_WHITELISTED
        value: 'true'
      - key: DISMISSIBLE_VALIDATION_TRANSFORM
        value: 'true'

      # JWT Authentication
      # Set to "false" to disable authentication, or configure your OIDC provider
      - key: DISMISSIBLE_JWT_AUTH_ENABLED
        value: 'false'
      # Uncomment and configure for production with your OIDC provider:
      # - key: DISMISSIBLE_JWT_AUTH_WELL_KNOWN_URL
      #   sync: false  # Set in Render dashboard
      # - key: DISMISSIBLE_JWT_AUTH_ISSUER
      #   sync: false  # Set in Render dashboard
      # - key: DISMISSIBLE_JWT_AUTH_AUDIENCE
      #   sync: false  # Set in Render dashboard
      # - key: DISMISSIBLE_JWT_AUTH_ALGORITHMS
      #   value: 'RS256'
      # - key: DISMISSIBLE_JWT_AUTH_JWKS_CACHE_DURATION
      #   value: '600000'
      # - key: DISMISSIBLE_JWT_AUTH_REQUEST_TIMEOUT
      #   value: '30000'
      # - key: DISMISSIBLE_JWT_AUTH_PRIORITY
      #   value: '-100'

      # Node environment
      - key: NODE_ENV
        value: 'production'

databases:
  - name: dismissible-db
    plan: starter
    region: oregon
    databaseName: dismissible
    user: dismissible
    ipAllowList: [] # Only allow connections from Render services

