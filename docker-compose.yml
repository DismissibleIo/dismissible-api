services:
  dismissible-api:
    build: .
    container_name: dismissible-api
    restart: unless-stopped
    depends_on:
      - dismissible-postgres
      - localstack
    environment:
      # Server
      DISMISSIBLE_PORT: 3001
      DISMISSIBLE_SWAGGER_ENABLED: true
      DISMISSIBLE_POSTGRES_STORAGE_CONNECTION_STRING: postgresql://postgres:postgres@dismissible-postgres:5432/dismissible

      # DynamoDB Storage (LocalStack)
      DISMISSIBLE_DYNAMODB_TABLE_NAME: dismissible-items
      DISMISSIBLE_DYNAMODB_AWS_REGION: us-east-1
      DISMISSIBLE_DYNAMODB_LOCALSTACK_ENDPOINT: http://localstack:4566
      DISMISSIBLE_DYNAMODB_AWS_ACCESS_KEY_ID: test
      DISMISSIBLE_DYNAMODB_AWS_SECRET_ACCESS_KEY: test

      # JWT Authentication (disabled for local development)
      DISMISSIBLE_JWT_AUTH_ENABLED: false
      # Uncomment and configure for production with your OIDC provider:
      # DISMISSIBLE_JWT_AUTH_ENABLED: true
      # DISMISSIBLE_JWT_AUTH_WELL_KNOWN_URL: https://your-tenant.auth0.com/.well-known/openid-configuration
      # DISMISSIBLE_JWT_AUTH_ISSUER: https://your-tenant.auth0.com/
      # DISMISSIBLE_JWT_AUTH_AUDIENCE: your-api-identifier

      # Security Headers (Helmet)
      DISMISSIBLE_HELMET_ENABLED: true
      DISMISSIBLE_HELMET_CSP: false
      DISMISSIBLE_HELMET_COEP: false
      DISMISSIBLE_HELMET_HSTS_MAX_AGE: 31536000
      DISMISSIBLE_HELMET_HSTS_INCLUDE_SUBDOMAINS: true
      DISMISSIBLE_HELMET_HSTS_PRELOAD: false

      # CORS
      DISMISSIBLE_CORS_ENABLED: true
      DISMISSIBLE_CORS_ORIGINS: http://localhost:3000
      DISMISSIBLE_CORS_METHODS: GET,POST,DELETE,OPTIONS
      DISMISSIBLE_CORS_ALLOWED_HEADERS: Content-Type,Authorization,x-request-id
      DISMISSIBLE_CORS_CREDENTIALS: true
      DISMISSIBLE_CORS_MAX_AGE: 86400
    ports:
      - '3001:3001'

  dismissible-postgres:
    image: postgres:latest
    container_name: dismissible-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: dismissible
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql

  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    restart: unless-stopped
    environment:
      # Enable specific LocalStack services
      SERVICES: dynamodb
      # AWS region configuration
      AWS_DEFAULT_REGION: us-east-1
      # LocalStack configuration
      DEBUG: 1
      # Persistence mode (optional - data persists across restarts)
      # PERSISTENCE: 1
    ports:
      - '4566:4566'
    volumes:
      - localstack_data:/var/lib/localstack
      # Share a Docker network for inter-container communication
    networks:
      - default

networks:
  default:
    name: dismissible-network

volumes:
  postgres_data:
  localstack_data:
